<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Vocabulary Practice</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            line-height: 1.6;
        }

        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 700px;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .mode-selection {
            margin-bottom: 25px;
            text-align: left;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .mode-selection label {
            margin-right: 10px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 5px;
        }

        .display-area {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            min-height: 1.5em;
            background-color: #f8f9fa;
            padding: 12px 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            text-align: center;
            display: none;
        }

        #review-display {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #review-display span {
            display: block;
            line-height: 1.4;
        }
        #review-display #word-text {
            color: #0056b3;
            font-size: 2.6em;
            font-weight: bold;
        }
        #review-display #word-pronunciation {
            font-size: 1.2em;
            font-style: italic;
            color: #555;
        }
        #review-display #word-meaning-review {
            font-size: 1.1em;
            color: #28a745;
            font-weight: normal;
        }

        #prompt-display {
            color: #0056b3;
            font-style: italic;
            text-align: center;
        }
        #prompt-display.missing-pronunciation {
            color: #dc3545;
            font-style: italic;
            font-size: 1em;
        }

        #prompt {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 15px;
            min-height: 1.5em;
        }

        #word-input {
            width: calc(100% - 30px);
            padding: 12px 15px;
            margin: 5px auto;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 1em;
            background-color: #fff;
            color: #333;
            display: none;
            text-align: center;
        }
        .input-visible #word-input {
            display: block;
        }

        #attempt-counter {
            font-size: 0.9em;
            color: #888;
            min-height: 1.2em;
            margin-bottom: 15px;
            display: none;
        }
        .attempts-visible #attempt-counter {
            display: block;
        }

        #action-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 20px;
            min-height: 50px;
            display: none;
        }
        .buttons-visible #action-buttons {
            display: flex;
        }

        #action-buttons button {
            padding: 10px 18px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            color: white;
            margin: 5px;
            transition: background-color 0.3s ease;
            flex-shrink: 0;
        }

        #speak-button { background-color: #28a745; order: 1; }
        #speak-button:hover { background-color: #218838; }
        #check-button { background-color: #007bff; order: 2; }
        #check-button:hover { background-color: #0056b3; }
        #next-word-button { background-color: #ffc107; color: #333; order: 3; }
        #next-word-button:hover { background-color: #e0a800; }
        #action-buttons button:disabled { background-color: #cccccc; cursor: not-allowed; }

        #feedback {
            margin-top: 10px;
            font-weight: bold;
            min-height: 1.5em;
        }
        #feedback.correct { color: green; }
        #feedback.incorrect { color: red; }
        #feedback.reveal { color: #dc3545; }

        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
            display: none;
            text-align: left;
        }
        #result p { margin: 5px 0; font-size: 1.1em; }
        #result #correct-word { font-weight: bold; color: #333; }
        #result #meaning { color: #0056b3; font-weight: bold; }

        #progress {
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vocabulary Practice</h1>

        <div class="mode-selection">
            <label>Select Mode:</label>
            <label><input type="radio" name="mode" value="review" checked> Review</label>
            <label><input type="radio" name="mode" value="dictation"> Dictation (IPA -> Word)</label>
            <label><input type="radio" name="mode" value="listening"> Listening (Audio -> Word)</label>
        </div>

        <div id="review-display" class="display-area">
            <span id="word-text"></span>
            <span id="word-syllables"></span>
            <span id="word-pronunciation"></span>
            <span id="word-meaning-review" style="display: none;"></span>
        </div>
        <div id="prompt-display" class="display-area"></div>

        <div id="prompt">Please select a mode to start.</div>

        <input type="text" id="word-input" placeholder="Type the word here..." autocomplete="off">
        <div id="attempt-counter"></div>

        <div id="action-buttons">
            <button id="speak-button">Speak Again</button>
            <button id="check-button">Check</button>
            <button id="next-word-button" style="display: none;">Next Word</button>
        </div>

        <div id="feedback"></div>

        <div id="result">
            <p id="correct-word"></p>
            <p id="meaning"></p>
        </div>

        <div id="progress"></div>
    </div>

    <script>
        // --- DOM References ---
        const containerDiv = document.querySelector('.container');
        const wordInput = document.getElementById('word-input');
        const checkButton = document.getElementById('check-button');
        const speakButton = document.getElementById('speak-button');
        const nextWordButton = document.getElementById('next-word-button');
        const feedbackDiv = document.getElementById('feedback');
        const resultDiv = document.getElementById('result');
        const correctWordP = document.getElementById('correct-word');
        const meaningP = document.getElementById('meaning');
        const progressDiv = document.getElementById('progress');
        const promptDiv = document.getElementById('prompt');
        const reviewDisplayDiv = document.getElementById('review-display');
        const wordTextSpan = document.getElementById('word-text');
        const wordSyllablesSpan = document.getElementById('word-syllables');
        const wordPronunciationSpan = document.getElementById('word-pronunciation');
        const wordMeaningReviewSpan = document.getElementById('word-meaning-review');
        const promptDisplayDiv = document.getElementById('prompt-display');
        const attemptCounterDiv = document.getElementById('attempt-counter');
        const modeRadios = document.querySelectorAll('input[name="mode"]');
        const actionButtonsDiv = document.getElementById('action-buttons');

        // --- Congratulation Messages ---
        const congratulationMessages = [
            "Good job!", "Excellent!", "Well done!", "Perfect!", "Amazing!",
            "做得好！", "太棒了！", "非常好！", "完美！", "加鸡腿", "真厉害！", "你真牛!", "太厉害了!"
        ];

        // --- Word Data ---
        const wordsData = [
            {
                "unit": "Unit 1",
                "words": [
                    {
                        "word": "sci-fi movie",
                        "syllables": "sci / fi · moo / vie",
                        "pronunciation": "/ˈsaɪ.faɪ ˈmuːvi/",
                        "meaning": "科幻电影"
                    },
                    {
                        "word": "mystery",
                        "syllables": "mys / ter / y",
                        "pronunciation": "/ˈmɪstəri/",
                        "meaning": "悬疑片"
                    },
                    {
                        "word": "adventure movie",
                        "syllables": "ad / ven / ture · moo / vie",
                        "pronunciation": "/ədˈventʃər ˈmuːvi/",
                        "meaning": "冒险电影"
                    },
                    {
                        "word": "action movie",
                        "syllables": "ac / tion · moo / vie",
                        "pronunciation": "/ˈækʃən ˈmuːvi/",
                        "meaning": "动作电影"
                    },
                    {
                        "word": "fantasy movie",
                        "syllables": "fan / ta / sy · moo / vie",
                        "pronunciation": "/ˈfæntəsi ˈmuːvi/",
                        "meaning": "奇幻电影"
                    },
                    {
                        "word": "horror movie",
                        "syllables": "hor / ror · moo / vie",
                        "pronunciation": "/ˈhɔrər ˈmuːvi/",
                        "meaning": "恐怖电影"
                    },
                    {
                        "word": "stuntwoman",
                        "syllables": "stunt / wo / man",
                        "pronunciation": "/ˈstʌntˌwʊmən/",
                        "meaning": "女特技演员"
                    },
                    {
                        "word": "actress",
                        "syllables": "act / ress",
                        "pronunciation": "/ˈæktrəs/",
                        "meaning": "女演员"
                    },
                    {
                        "word": "cameraman",
                        "syllables": "ca / me / ra / man",
                        "pronunciation": "/ˈkæmərəˌmæn/",
                        "meaning": "摄影师"
                    },
                    {
                        "word": "director",
                        "syllables": "di / rec / tor",
                        "pronunciation": "/dəˈrektər/",
                        "meaning": "导演"
                    },
                    {
                        "word": "actor",
                        "syllables": "ac / tor",
                        "pronunciation": "/ˈæktər/",
                        "meaning": "男演员"
                    },
                    {
                        "word": "martial arts",
                        "syllables": "mar / tial · arts",
                        "pronunciation": "/ˈmɑrʃəl ɑrts/",
                        "meaning": "武术"
                    },
                    {
                        "word": "animated movie",
                        "syllables": "an / i / ma / ted · moo / vie",
                        "pronunciation": "/ˈænɪmeɪtɪd ˈmuːvi/",
                        "meaning": "动画电影"
                    },
                    {
                        "word": "comedy",
                        "syllables": "com / e / dy",
                        "pronunciation": "/ˈkɑmədi/",
                        "meaning": "喜剧"
                    },
                    {
                        "word": "romantic movie",
                        "syllables": "ro / man / tic · moo / vie",
                        "pronunciation": "/roʊˈmæntɪk ˈmuːvi/",
                        "meaning": "爱情电影"
                    },
                    {
                        "word": "exciting",
                        "syllables": "ex / cit / ing",
                        "pronunciation": "/ɪkˈsaɪtɪŋ/",
                        "meaning": "令人兴奋的"
                    }
                ]
            }
        ];

        // Initialize unit index and shuffled words
        let currentUnitIndex = 0;
        let shuffledWords = [...wordsData[currentUnitIndex].words];
        promptDiv.textContent = 'Please select a mode to start.';

        let currentWordIndex = 0;
        let incorrectAttempts = 0;
        const MAX_ATTEMPTS = 3;
        let currentMode = 'review';
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        const pronunciationPlaceholder = "No IPA available";

        // --- Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function speakWord(text) {
            if (!text) return;

            if (!document.hasFocus()) {
                console.log('等待用户交互...');
                feedbackDiv.textContent = '请点击页面任意位置以启用语音';
                feedbackDiv.className = 'info';
                return;
            }

            if (synth.speaking) synth.cancel();
            if (currentUtterance) synth.cancel();

            let voices = synth.getVoices();
            if (voices.length === 0) {
                synth.onvoiceschanged = () => {
                    voices = synth.getVoices();
                    if (voices.length > 0) {
                        synth.onvoiceschanged = null;
                        speakWord(text);
                    }
                };
                return;
            }

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.onend = () => { currentUtterance = null; };

            let retryCount = 0;
            const maxRetries = 3;

            currentUtterance.onerror = (event) => {
                console.error('语音合成错误:', event);
                if (retryCount < maxRetries) {
                    retryCount++;
                    console.log(`尝试重新合成语音 (${retryCount}/${maxRetries})`);
                    setTimeout(() => {
                        if (synth.speaking) synth.cancel();
                        const newUtterance = new SpeechSynthesisUtterance(text);
                        newUtterance.onend = () => { currentUtterance = null; };
                        newUtterance.onerror = currentUtterance.onerror;
                        if (selectedVoice) {
                            newUtterance.voice = selectedVoice;
                            newUtterance.pitch = 1.1;
                            newUtterance.rate = 0.9;
                        }
                        newUtterance.volume = 1;
                        currentUtterance = newUtterance;
                        synth.speak(currentUtterance);
                    }, 1000);
                } else {
                    feedbackDiv.textContent = '语音合成暂时不可用，请稍后再试';
                    feedbackDiv.className = 'incorrect';
                    currentUtterance = null;
                }
            };

            let selectedVoice = voices.find(voice => voice.lang.startsWith('zh-')) ||
                               voices.find(voice => voice.lang.startsWith('zh_')) ||
                               voices.find(voice => voice.lang.startsWith('en-')) ||
                               voices.find(voice => voice.lang.startsWith('en_'));

            if (selectedVoice) {
                currentUtterance.voice = selectedVoice;
                currentUtterance.pitch = 1.1;
                currentUtterance.rate = 0.9;
            }

            currentUtterance.volume = 1;

            try {
                synth.speak(currentUtterance);
            } catch (error) {
                console.error('语音合成初始化失败:', error);
                feedbackDiv.textContent = '语音功能初始化失败，请刷新页面重试';
                feedbackDiv.className = 'incorrect';
            }
        }

        function showResultDetails() {
            const currentWordData = shuffledWords[currentWordIndex];
            if (!currentWordData) return;
            resultDiv.style.display = 'block';
            const pronunciationText = currentWordData.pronunciation && currentWordData.pronunciation !== pronunciationPlaceholder ? ` ${currentWordData.pronunciation}` : '';
            correctWordP.textContent = `Word: ${currentWordData.word}${pronunciationText}`;
            meaningP.textContent = currentWordData.meaning ? `Meaning: ${currentWordData.meaning}` : 'Meaning: Not available';
            meaningP.style.display = 'block';
        }

        function loadWord() {
            if (currentWordIndex >= shuffledWords.length) {
                currentUnitIndex++;
                if (currentUnitIndex >= wordsData.length) {
                    promptDiv.textContent = 'Congratulations! You have completed all units!';
                    feedbackDiv.textContent = '';
                    resultDiv.style.display = 'none';
                    reviewDisplayDiv.style.display = 'none';
                    promptDisplayDiv.style.display = 'none';
                    containerDiv.classList.remove('input-visible', 'attempts-visible', 'buttons-visible');
                    progressDiv.textContent = `Mode: ${getModeName(currentMode)} | Total ${shuffledWords.length} words completed.`;
                    return;
                }
                shuffledWords = [...wordsData[currentUnitIndex].words];
                currentWordIndex = 0;
            }
            const currentWordData = shuffledWords[currentWordIndex];
            incorrectAttempts = 0;
            feedbackDiv.textContent = ''; feedbackDiv.className = '';
            resultDiv.style.display = 'none';
            wordInput.value = ''; wordInput.disabled = false;
            checkButton.disabled = false; checkButton.style.display = 'inline-block';
            nextWordButton.style.display = 'none';
            speakButton.disabled = false; speakButton.style.display = 'inline-block';
            attemptCounterDiv.textContent = '';
            reviewDisplayDiv.style.display = 'none'; promptDisplayDiv.style.display = 'none';
            promptDisplayDiv.classList.remove('missing-pronunciation');
            wordMeaningReviewSpan.style.display = 'none'; wordMeaningReviewSpan.textContent = '';
            containerDiv.classList.remove('input-visible', 'attempts-visible', 'buttons-visible');
            containerDiv.classList.add('buttons-visible');
            let hasPronunciation = currentWordData.pronunciation && currentWordData.pronunciation !== pronunciationPlaceholder;

            switch (currentMode) {
                case 'review':
                    promptDiv.textContent = 'Review Mode: See the word and IPA, type the word.';
                    wordTextSpan.textContent = currentWordData.word;
                    wordSyllablesSpan.textContent = currentWordData.syllables;
                    wordPronunciationSpan.textContent = currentWordData.pronunciation || pronunciationPlaceholder;
                    wordMeaningReviewSpan.textContent = currentWordData.meaning;
                    wordMeaningReviewSpan.style.display = 'block';
                    reviewDisplayDiv.style.display = 'block';
                    containerDiv.classList.add('input-visible');
                    checkButton.textContent = 'Check';
                    speakButton.style.display = 'inline-block';
                    wordInput.focus();
                    speakWord(currentWordData.word);
                    break;
                case 'dictation':
                    promptDiv.textContent = 'Dictation Mode: Type the English word based on the IPA.';
                    if (hasPronunciation) {
                        promptDisplayDiv.textContent = currentWordData.pronunciation;
                        speakWord(currentWordData.word);
                    } else {
                        promptDisplayDiv.textContent = "(Cannot use this mode: IPA missing for this word)";
                        promptDisplayDiv.classList.add('missing-pronunciation');
                        wordInput.disabled = true;
                        checkButton.disabled = true;
                    }
                    promptDisplayDiv.style.display = 'block';
                    containerDiv.classList.add('input-visible', 'attempts-visible');
                    checkButton.textContent = 'Check';
                    speakButton.style.display = 'inline-block';
                    updateAttemptCounter();
                    if (!wordInput.disabled) wordInput.focus();
                    break;
                case 'listening':
                    promptDiv.textContent = 'Listening Mode: Listen to the audio, type the English word.';
                    containerDiv.classList.add('input-visible', 'attempts-visible');
                    checkButton.textContent = 'Check'; speakButton.style.display = 'inline-block';
                    updateAttemptCounter();
                    wordInput.focus();
                    setTimeout(() => speakWord(currentWordData.word), 150);
                    break;
            }
            updateProgress();
        }

        function handleCheckAction() {
            if (currentWordIndex >= shuffledWords.length || checkButton.disabled || checkButton.style.display === 'none') return;

            const currentWordData = shuffledWords[currentWordIndex];
            const userInput = wordInput.value.trim().toLowerCase();
            const correctWordLower = currentWordData.word.toLowerCase();
            const nextWordData = currentWordIndex + 1 < shuffledWords.length ? shuffledWords[currentWordIndex + 1] : null;

            if (userInput === correctWordLower) {
                feedbackDiv.textContent = 'Correct!';
                feedbackDiv.className = 'correct';
                if (nextWordData) {
                    const randomMessage = congratulationMessages[Math.floor(Math.random() * congratulationMessages.length)];
                    speakWord(randomMessage);
                    setTimeout(() => {
                        currentWordIndex++;
                        loadWord();
                    }, 1000);
                } else {
                    currentWordIndex++;
                    loadWord();
                }
                return;
            } else {
                feedbackDiv.textContent = 'Incorrect, please try again.';
                feedbackDiv.className = 'incorrect';
                wordInput.value = '';
                wordInput.focus();
                speakWord("Uh-oh, try again");
                setTimeout(() => speakWord(currentWordData.word), 2000);
                if (currentMode === 'listening') {
                    incorrectAttempts++;
                    updateAttemptCounter();
                    if (incorrectAttempts >= MAX_ATTEMPTS) {
                        feedbackDiv.textContent = `Attempts exceeded! The correct word was: ${currentWordData.word}`;
                        feedbackDiv.className = 'reveal';
                        showResultDetails();
                        wordInput.disabled = true;
                        checkButton.style.display = 'none';
                        nextWordButton.style.display = 'inline-block';
                        containerDiv.classList.remove('attempts-visible');
                    }
                }
            }
        }

        function updateAttemptCounter() {
            if ((currentMode === 'dictation' || currentMode === 'listening') && !wordInput.disabled) {
                attemptCounterDiv.textContent = `Attempts remaining: ${MAX_ATTEMPTS - incorrectAttempts}`;
            } else {
                attemptCounterDiv.textContent = '';
            }
        }

        function updateProgress() {
            progressDiv.textContent = `Mode: ${getModeName(currentMode)} | Progress: ${currentWordIndex + 1} / ${shuffledWords.length}`;
        }

        function getModeName(modeValue) {
            switch(modeValue) {
                case 'review': return 'Review';
                case 'dictation': return 'Dictation';
                case 'listening': return 'Listening';
                default: return '';
            }
        }

        // --- Event Listeners ---
        checkButton.addEventListener('click', handleCheckAction);
        wordInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !wordInput.disabled && checkButton.style.display !== 'none') {
                event.preventDefault();
                handleCheckAction();
            }
        });
        speakButton.addEventListener('click', () => {
            if (currentWordIndex < shuffledWords.length) {
                speakWord(shuffledWords[currentWordIndex].word);
                if (containerDiv.classList.contains('input-visible') && !wordInput.disabled) {
                    wordInput.focus();
                }
            }
        });
        nextWordButton.addEventListener('click', () => {
            currentWordIndex++;
            loadWord();
        });
        modeRadios.forEach(radio => {
            radio.addEventListener('change', (event) => {
                currentMode = event.target.value;
                currentWordIndex = 0;
                shuffleArray(shuffledWords);
                loadWord();
            });
        });

        // --- Initialization ---
        let speechInitialized = false;
        function initializeSpeech() {
            if (!speechInitialized) {
                try {
                    if (synth.paused) synth.resume();
                    const silentUtterance = new SpeechSynthesisUtterance('');
                    silentUtterance.volume = 0;
                    synth.speak(silentUtterance);
                    speechInitialized = true;
                    console.log("Speech synthesis potentially initialized.");
                } catch (error) {
                    console.error("Speech synthesis initialization failed:", error);
                    promptDiv.textContent = 'Speech synthesis could not be initialized. Audio might not work.';
                } finally {
                    currentMode = document.querySelector('input[name="mode"]:checked').value;
                    shuffleArray(shuffledWords);
                    loadWord();
                }
            }
        }

        containerDiv.classList.remove('input-visible', 'attempts-visible', 'buttons-visible');
        promptDiv.textContent = 'Please select a mode and click anywhere on the page to activate audio.';
        progressDiv.textContent = `Mode: ${getModeName(currentMode)}`;
        document.body.addEventListener('click', initializeSpeech, { once: true });
        setTimeout(initializeSpeech, 150);
    </script>
</body>
</html>